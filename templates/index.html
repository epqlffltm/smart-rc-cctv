<!DOCTYPE html>
<html>
<head>
    <title>Picar-X Control Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>
    <style>
        body { text-align: center; font-family: sans-serif; background: #222; color: white; }
        .container { display: flex; flex-direction: column; align-items: center; }
        #video-feed { width: 80%; max-width: 640px; border: 2px solid #555; margin-top: 10px; }
        .controls { display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap; justify-content: center; }
        #joystick { width: 150px; height: 150px; background: #444; border-radius: 50%; position: relative; }
        .cam-buttons button, .rec-button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        .rec-button { background: red; color: white; border: none; border-radius: 5px; }
        .rec-button.active { background: gray; }
    </style>
</head>
<body>
    <div class="container">
        <img id="video-feed" src="http://localhost:9000/mjpg">
        
        <div class="controls">
            <div id="joystick"></div>
            
            <div class="cam-buttons">
                <h3>Camera Pan/Tilt</h3>
                <button onclick="controlCam('up')">UP</button><br>
                <button onclick="controlCam('left')">LEFT</button>
                <button onclick="controlCam('center')">CENTER</button>
                <button onclick="controlCam('right')">RIGHT</button><br>
                <button onclick="controlCam('down')">DOWN</button>
            </div>

            <div>
                <h3>Recording</h3>
                <button id="recBtn" class="rec-button" onclick="toggleRecord()">REC START</button>
            </div>
        </div>
    </div>

    <script>
        // 조이스틱 설정
        var joystick = nipplejs.create({
            zone: document.getElementById('joystick'),
            mode: 'static',
            position: {left: '50%', top: '50%'},
            color: 'blue'
        });

        joystick.on('move', function (evt, data) {
            if (data.angle) {
                let angle = Math.cos(data.angle.radian) * 35; // 조향각 계산
                let speed = Math.sin(data.angle.radian) * 50; // 속도 계산
                fetch('/move', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({angle: -angle, speed: speed})
                });
            }
        });

        joystick.on('end', function () {
            fetch('/move', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({angle: 0, speed: 0})
            });
        });

        // 카메라 제어
        function controlCam(action) {
            fetch('/camera', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: action})
            });
        }

        // 녹화 제어
        let isRecording = false;
        function toggleRecord() {
            const btn = document.getElementById('recBtn');
            fetch('/record', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'recording') {
                    btn.innerText = "REC STOP";
                    btn.classList.add('active');
                } else {
                    btn.innerText = "REC START";
                    btn.classList.remove('active');
                    alert("Video saved!");
                }
            });
        }

        // 비디오 피드 주소 동적 설정 (접속한 IP 기준)
        document.getElementById('video-feed').src = "http://" + window.location.hostname + ":9000/mjpg";
    </script>
</body>
</html>