<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Picar-X CCTV Pro Control Center</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        /* ê¸°ë³¸ í…Œë§ˆ ë° ë ˆì´ì•„ì›ƒ */
        body { text-align: center; font-family: 'Segoe UI', sans-serif; background: #111; color: white; margin: 0; touch-action: manipulation; }
        #video-feed { width: 100%; max-width: 800px; border-bottom: 3px solid #333; background: #000; }
        
        .grid-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; max-width: 1000px; margin: 0 auto; }
        .card { background: #222; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        h3 { margin-top: 0; color: #aaa; font-size: 1.1em; letter-spacing: 1px; }

        /* ì¡°ì¢… D-Pad ìŠ¤íƒ€ì¼ */
        .d-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; width: 180px; margin: 0 auto; }
        .btn { padding: 18px 0; background: #333; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.2s; -webkit-tap-highlight-color: transparent; }
        .btn:active { background: #555; transform: scale(0.95); }
        
        /* ê¸°ëŠ¥ë³„ ë²„íŠ¼ ìƒ‰ìƒ */
        .btn-auto { background: #0056b3; width: 100%; margin-bottom: 15px; font-size: 1em; }
        .btn-rec { background: #900; width: 100%; margin-top: 20px; font-size: 1em; }
        .btn-link { background: #28a745; width: 90%; padding: 15px; margin: 20px auto; display: block; text-decoration: none; color: white; font-weight: bold; border-radius: 10px; transition: 0.3s; }
        .btn-link:hover { background: #218838; }

        /* í™”ë©´ ë…¹í™” ì œì–´ ë° ìƒíƒœ í‘œì‹œ */
        .controls { background: #1a1a1a; padding: 20px; border-top: 1px solid #333; }
        #rec-status { font-size: 1em; color: #ff4444; font-weight: bold; margin-bottom: 10px; display: none; }
        .recording-dot { width: 12px; height: 12px; background-color: #ff0000; border-radius: 50%; display: inline-block; animation: blink 1s infinite; margin-right: 8px; vertical-align: middle; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0; } 100% { opacity: 1; } }

        .btn-screen { background-color: #28a745; color: white; padding: 12px 25px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .btn-stop { background-color: #dc3545; color: white; padding: 12px 25px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; display: none; }
    </style>
</head>
<body>

    <img id="video-feed" src="" alt="Live Stream Offline">

    <div class="grid-container">
        <div class="card">
            <h3>DRIVE CONTROL</h3>
            <div class="d-pad">
                <div></div>
                <button class="btn" onmousedown="move('forward')" onmouseup="move('stop')" ontouchstart="move('forward')" ontouchend="move('stop')">â–²</button>
                <div></div>
                <button class="btn" onmousedown="move('left')" onmouseup="move('stop')" ontouchstart="move('left')" ontouchend="move('stop')">â—€</button>
                <button class="btn" onclick="move('stop')">â– </button>
                <button class="btn" onmousedown="move('right')" onmouseup="move('stop')" ontouchstart="move('right')" ontouchend="move('stop')">â–¶</button>
                <div></div>
                <button class="btn" onmousedown="move('backward')" onmouseup="move('stop')" ontouchstart="move('backward')" ontouchend="move('stop')">â–¼</button>
                <div></div>
            </div>
        </div>

        <div class="card">
            <h3>SMART & CAM</h3>
            <button id="autoBtn" class="btn btn-auto" onclick="toggleAuto()">SMART MODE: OFF</button>
            <div class="d-pad">
                <div></div><button class="btn" onclick="cam('up')">U</button><div></div>
                <button class="btn" onclick="cam('left')">L</button>
                <button class="btn" onclick="cam('center')">M</button>
                <button class="btn" onclick="cam('right')">R</button>
                <div></div><button class="btn" onclick="cam('down')">D</button><div></div>
            </div>
            <button id="recBtn" class="btn btn-rec" onclick="toggleRecord()">ğŸ”´ SERVER REC START</button>
        </div>
    </div>

    <a href="/videos" class="btn-link"> 1.4TB ì˜ìƒ ë³´ê´€í•¨ ë°©ë¬¸ (ì¬ìƒ/ë‹¤ìš´ë¡œë“œ)</a>

    <div class="controls">
        <div id="rec-status"><span class="recording-dot"></span> í™”ë©´ ë…¹í™” ì¤‘...</div>
        <button id="screenRecordBtn" class="btn-screen" onclick="startScreenRecord()">ğŸ–¥ï¸ í˜„ì¬ í™”ë©´ ë…¹í™” ì‹œì‘</button>
        <button id="stopRecordBtn" class="btn-stop" onclick="stopScreenRecord()">â¹ ë…¹í™” ì¤‘ì§€ ë° ì €ì¥</button>
    </div>

    <script>
        // ìŠ¤íŠ¸ë¦¬ë° ì„œë²„ ì£¼ì†Œ ì„¤ì •
        document.getElementById('video-feed').src = "http://" + window.location.hostname + ":9000/mjpg";

        // ê¸°ë³¸ ì œì–´ í•¨ìˆ˜
        function move(c) { fetch(`/move?cmd=${c}`); }
        function cam(c) { fetch(`/camera?cmd=${c}`); }
        
        // ìŠ¤ë§ˆíŠ¸ ëª¨ë“œ í† ê¸€
        let autoOn = false;
        function toggleAuto() {
            autoOn = !autoOn;
            const b = document.getElementById('autoBtn');
            b.innerText = autoOn ? "SMART MODE: ON" : "SMART MODE: OFF";
            b.style.background = autoOn ? "#28a745" : "#0056b3";
            fetch(`/auto_mode?status=${autoOn ? 'on' : 'off'}`);
        }

        // ì„œë²„ ì‚¬ì´ë“œ ë…¹í™” í† ê¸€ (Picar-X ë³¸ì²´ ì €ì¥)
        let recOn = false;
        function toggleRecord() {
            recOn = !recOn;
            const b = document.getElementById('recBtn');
            b.innerText = recOn ? "ğŸ”´ STOP RECORDING" : "ğŸ”´ SERVER REC START";
            b.style.background = recOn ? "#444" : "#900";
            fetch(`/record?status=${recOn ? 'start' : 'stop'}`);
        }

        /* ë¸Œë¼ìš°ì € í™”ë©´ ë…¹í™” ë¡œì§ (í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ) */
        let mediaRecorder;
        let recordedChunks = [];

        async function startScreenRecord() {
            try {
                // í™”ë©´ ìº¡ì²˜ ê¶Œí•œ ìš”ì²­
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { cursor: "always" },
                    audio: false
                });

                // ë ˆì½”ë” ì„¤ì • (VP9 ì½”ë± ì‚¬ìš©)
                mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp9' });

                mediaRecorder.ondataavailable = (e) => {
                    if (e.data.size > 0) recordedChunks.push(e.data);
                };

                // ë…¹í™” ì¢…ë£Œ ì‹œ íŒŒì¼ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
                mediaRecorder.onstop = () => {
                    const blob = new Blob(recordedChunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `picar-x-dash-${new Date().getTime()}.webm`;
                    a.click();
                    recordedChunks = [];
                    
                    document.getElementById('screenRecordBtn').style.display = 'inline-block';
                    document.getElementById('stopRecordBtn').style.display = 'none';
                    document.getElementById('rec-status').style.display = 'none';
                };

                mediaRecorder.start();
                
                // UI ì—…ë°ì´íŠ¸ (ê¹œë¹¡ì´ëŠ” ì  í‘œì‹œ)
                document.getElementById('rec-status').style.display = 'block';
                document.getElementById('screenRecordBtn').style.display = 'none';
                document.getElementById('stopRecordBtn').style.display = 'inline-block';

            } catch (err) {
                console.error("í™”ë©´ ë…¹í™” ì—ëŸ¬: " + err);
                alert("ë…¹í™”ë¥¼ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (ê¶Œí•œ ê±°ë¶€ ë“±)");
            }
        }

        function stopScreenRecord() {
            if(mediaRecorder) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
        }
    </script>
</body>
</html>