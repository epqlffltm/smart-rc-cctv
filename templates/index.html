<!DOCTYPE html>
<html>
<head>
    <title>Picar-X Control Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.9.0/nipplejs.min.js"></script>
    <style>
        body { text-align: center; font-family: sans-serif; background: #222; color: white; }
        .container { display: flex; flex-direction: column; align-items: center; }
        #video-feed { width: 80%; max-width: 640px; border: 2px solid #555; margin-top: 10px; }
        .controls { display: flex; gap: 20px; margin-top: 20px; flex-wrap: wrap; justify-content: center; }
        #joystick { width: 150px; height: 150px; background: #444; border-radius: 50%; position: relative; }
        .cam-buttons button, .rec-button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin: 2px; }
        .rec-button { background: red; color: white; border: none; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Picar-X Web Control</h1>
    <div class="container">
        <img id="video-feed" src="">
        <div class="controls">
            <div id="joystick"></div>
            <div class="cam-buttons">
                <h3>Camera Pan/Tilt</h3>
                <button onclick="controlCam('up')">UP</button><br>
                <button onclick="controlCam('left')">LEFT</button>
                <button onclick="controlCam('center')">CENTER</button>
                <button onclick="controlCam('right')">RIGHT</button><br>
                <button onclick="controlCam('down')">DOWN</button>
            </div>
            <div>
                <h3>Recording</h3>
                <button id="recBtn" class="rec-button" onclick="toggleRecord()">REC START</button>
            </div>
        </div>
    </div>

    <script>
        // 영상 피드 주소 설정
        document.getElementById('video-feed').src = "http://" + window.location.hostname + ":9000/mjpg";

        let lastUpdateTime = 0;
        const updateInterval = 80; 
        const JOYSTICK_SIZE = 100;

        // 조이스틱 초기화
        var joystick = nipplejs.create({
            zone: document.getElementById('joystick'),
            mode: 'static',
            position: {left: '50%', top: '50%'},
            color: 'red',
            size: JOYSTICK_SIZE,
            threshold: 0.05
        });

        joystick.on('move', function (evt, data) {
            const now = Date.now();
            if (now - lastUpdateTime > updateInterval) {
                if (data.angle && data.distance) {
                    // 감도 계산 (민감하게 수정됨)
                    let strength = Math.min(data.distance / (JOYSTICK_SIZE / 2), 1.0);
                    let angle = Math.cos(data.angle.radian) * 35 * strength;
                    let speed = Math.sin(data.angle.radian) * 50 * strength;

                    sendMoveCommand(Math.round(-angle), Math.round(speed));
                }
                lastUpdateTime = now; // '지금'을 'now'로 복구
            }
        });

        joystick.on('end', function () {
            sendMoveCommand(0, 0);
        });

        function sendMoveCommand(angle, speed) {
            fetch('/move', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({angle: angle, speed: speed})
            });
        }

        function controlCam(action) {
            fetch('/camera', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: action})
            });
        }

        function toggleRecord() {
            const btn = document.getElementById('recBtn');
            fetch('/record', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'recording') {
                    btn.innerText = "REC STOP";
                    btn.style.background = "gray"; // '회색'을 'gray'로 복구
                } else {
                    btn.innerText = "REC START";
                    btn.style.background = "red"; // '빨간색'을 'red'로 복구
                    alert("Video saved in /home/Videos/");
                }
            });
        }
    </script>
</body>
</html>