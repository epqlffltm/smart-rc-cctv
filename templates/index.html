// 제어 주기 및 설정
let lastUpdateTime = 0;
const updateInterval = 80; // 전송 간격을 더 줄여 반응성 보강 (0.08초)
const JOYSTICK_SIZE = 100; // 내부 인식 크기를 작게 설정하여 민감도 향상

var joystick = nipplejs.create({
    zone: document.getElementById('joystick'),
    mode: 'static',
    position: {left: '50%', top: '50%'},
    color: 'red', // 시인성 개선
    size: JOYSTICK_SIZE, 
    threshold: 0.05 // 아주 작은 움직임도 바로 감지
});

joystick.on('move', function (evt, data) {
    const now = Date.now();
    
    if (now - lastUpdateTime > updateInterval) {
        if (data.angle && data.distance) {
            // [감도 핵심] 거리에 따른 강도를 더 가파르게 계산
            // JOYSTICK_SIZE의 절반이 최대 거리이므로, 이를 이용해 0~1 사이 값 생성
            let strength = Math.min(data.distance / (JOYSTICK_SIZE / 2), 1.0);
            
            // Picar-X 서보 한계인 -35~35도 사이로 계산
            let angle = Math.cos(data.angle.radian) * 35 * strength;
            
            // 전진/후진 속도 계산 (0~50 사이)
            let speed = Math.sin(data.angle.radian) * 50 * strength;

            // 정수로 변환하여 데이터 전송
            sendMoveCommand(Math.round(-angle), Math.round(speed));
        }
        lastUpdateTime = now;
    }
});

joystick.on('end', function () {
    // 손을 떼면 즉시 멈춤
    sendMoveCommand(0, 0);
});

function sendMoveCommand(angle, speed) {
    fetch('/move', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({angle: angle, speed: speed})
    });
}

// 카메라 제어 (더 큰 폭으로 움직이도록 수정)
function controlCam(action) {
    fetch('/camera', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({action: action})
    });
}

// 녹화 제어
function toggleRecord() {
    const btn = document.getElementById('recBtn');
    fetch('/record', { method: 'POST' })
    .then(res => res.json())
    .then(data => {
        if (data.status === 'recording') {
            btn.innerText = "REC STOP";
            btn.style.background = "gray";
        } else {
            btn.innerText = "REC START";
            btn.style.background = "red";
            alert("Video saved in /home/Videos/");
        }
    });
}